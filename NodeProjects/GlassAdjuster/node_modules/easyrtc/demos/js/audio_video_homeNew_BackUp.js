var selfEasyrtcid = "";
var recepientEasyrtcid = "";
var name="";
var ids=[];
function connect() {
	bootbox.prompt("Your Name:",function(result){ 
			name= result; 
			easyrtc.setUsername(name);
    			easyrtc.setRoomOccupantListener(convertListToButtons);
   			easyrtc.easyApp("easyrtc.audioVideo", "selfVideo", ["callerVideo"], loginSuccess, loginFailure);
	});
	//name = prompt('Please enter your name:');
	
 }


function clearConnectList() {
    var otherClientDiv = document.getElementById('otherClients');
    while (otherClientDiv.hasChildNodes()) {
        otherClientDiv.removeChild(otherClientDiv.lastChild);
    }
}


function convertListToButtons (roomName, data, isPrimary) {
    clearConnectList();
    var listCreated = false;
 if(!listCreated){
    $("#otherClients").append('<ul id="list" data-role="listview" data-filter="true" data-inset="true" data-split-icon="myapp-settings" data-split-theme="d"></ul>');
    listCreated = true;
    $("#otherClients").trigger("create");
var listItem = '<li data-role="list-divider" data-theme="a">Agents Online</li>';
$("#list").append(listItem);
}
    
    for(var i = 0, l = data.length; i < l; ++i){
   ids[i] = data[i];
   console.log("listCreated"+id[i]+" "+data[i] );
   }
   var i=0;
      for(var easyrtcid in data) {
      ids[i] = easyrtcid;
 i=i+1;

var value = easyrtc.idToName(easyrtcid);
var listItem = '<li><a>' + value + '</a><a class="startchat"></a></li>';
$("#list").append(listItem);
    $("#list").listview('refresh');
    /*
        var button = document.createElement('button');
        button.onclick = function(easyrtcid) {
            return function() {
                performCall(easyrtcid);
            };
        }(easyrtcid);


        var label = document.createTextNode("Connect to "+easyrtc.idToName(easyrtcid));
        button.appendChild(label);
         li.concat(button);
        $("ul").append(li.concat(easyrtc.idToName(easyrtcid)));
        
        */
         
         
   }
   $('#list').on('click', 'a', function () {

    //this gets the index by finding the first parent list-item element and getting it's index compared do its siblings
   var selected_index = $(this).parents('li').eq(0).index();
	 console.log(selected_index);
	  recepientEasyrtcid = ids[selected_index-1];
	  console.log(recepientEasyrtcid);
	   document.getElementById("videos").style.visibility = "visible";
	    document.getElementById("headings").style.visibility = "visible";
		document.getElementById("other").innerHTML  = easyrtc.idToName(recepientEasyrtcid);
   performCall(recepientEasyrtcid);
});
}


function performCall(otherEasyrtcid) {
    easyrtc.hangupAll();

    var successCB = function() {};
    var failureCB = function() {};
    easyrtc.call(otherEasyrtcid, successCB, failureCB);
}


function loginSuccess(easyrtcid) {
    selfEasyrtcid = easyrtcid;
    document.getElementById("iam").innerHTML =  name+" you can chat now" ;
}

function loginFailure(errorCode, message) {
    easyrtc.showError(errorCode, message);
}

function showUserInputForm(){
 
$('#sign_up').lightbox_me({
        centered: true, 
        onLoad: function() { 
            $('#sign_up').find('input:first').focus()
            }
        });
}
function showCoBrowsingInstructions(pin){
 
$('#coBrowsingInstructions').lightbox_me({
        centered: true, 
        onLoad: function() { 
            $('#coBrowsingPin').html(pin);
            }
        });
}